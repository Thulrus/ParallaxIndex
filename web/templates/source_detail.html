{% extends "base.html" %}

{% block title %}{{ source.display_name }} - Parallax Index{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>{{ source.display_name }}</h2>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/sources/{{ source.source_id }}/edit" class="btn" style="background: #2c5282; color: white;">Edit</a>
        <form method="POST" action="/sources/{{ source.source_id }}/toggle" style="display: inline;">
            <button type="submit" class="btn">
                {% if source.enabled %}Disable{% else %}Enable{% endif %}
            </button>
        </form>
        <button type="button" class="btn btn-success" onclick="collectNow('{{ source.source_id }}', '{{ source.display_name }}')" id="collect-btn">
            âš¡ Collect Now
        </button>
    </div>
</div>

<div id="notification-container"></div>

<div class="card">
    <h3>Source Information</h3>
    <table>
        <tr>
            <th>Plugin</th>
            <td>{{ plugin.display_name }} ({{ plugin.plugin_id }})</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if source.enabled %}
                <span class="badge badge-enabled">Enabled</span>
                {% else %}
                <span class="badge badge-disabled">Disabled</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Weight</th>
            <td>{{ source.weight }}</td>
        </tr>
        <tr>
            <th>Polarity</th>
            <td>{{ source.sentiment_polarity.value }}</td>
        </tr>
        <tr>
            <th>Schedule</th>
            <td><code>{{ source.schedule }}</code></td>
        </tr>
        <tr>
            <th>Configuration</th>
            <td><pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">{{ source.config | tojson(indent=2) }}</pre></td>
        </tr>
        <tr>
            <th>Created</th>
            <td>{{ source.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
        </tr>
    </table>
</div>

{% if history and history[0].metadata %}
<div class="card">
    <h3>Current Data</h3>
    {% set metadata = history[0].metadata %}
    {% if source.plugin_id == 'NUMERIC' or source.plugin_id == 'numeric_index' %}
        <table>
            <tr>
                <th>Sentiment Mode</th>
                <td>
                    <strong>{{ metadata.get('mode', 'change_tracking').replace('_', ' ').title() }}</strong>
                    {% if metadata.get('mode') == 'higher_is_better' %}
                        <span style="color: #2e7d32;">â†‘ Higher values are better</span>
                    {% elif metadata.get('mode') == 'lower_is_better' %}
                        <span style="color: #d32f2f;">â†“ Lower values are better</span>
                    {% elif metadata.get('mode') == 'target_is_best' %}
                        <span style="color: #1976d2;">ðŸŽ¯ Closer to target is better</span>
                    {% else %}
                        <span style="color: #6b7280;">Tracks percent change</span>
                    {% endif %}
                </td>
            </tr>
            {% if metadata.get('configured_min') is not none %}
            <tr>
                <th>Configured Range</th>
                <td>
                    {{ "%.2f"|format(metadata.configured_min) }} to {{ "%.2f"|format(metadata.configured_max) }}
                    {% if metadata.get('configured_midpoint') is not none %}
                        (midpoint: {{ "%.2f"|format(metadata.configured_midpoint) }})
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            <tr>
                <th>Current Value</th>
                <td style="font-size: 1.5rem; font-weight: bold; color: #2c5282;">{{ "%.2f"|format(metadata.current_value) }}</td>
            </tr>
            <tr>
                <th>Observed Range</th>
                <td>
                    {{ "%.2f"|format(metadata.get('observed_min', metadata.get('min_value', 0))) }} 
                    to 
                    {{ "%.2f"|format(metadata.get('observed_max', metadata.get('max_value', 0))) }}
                    (span: {{ "%.2f"|format(metadata.get('observed_max', metadata.get('max_value', 0)) - metadata.get('observed_min', metadata.get('min_value', 0))) }})
                </td>
            </tr>
            {% if metadata.previous_value is not none %}
            <tr>
                <th>Change from Previous</th>
                <td>
                    {% set change = metadata.current_value - metadata.previous_value %}
                    {% if change > 0 %}
                        <span style="color: #22c55e;">â–² {{ "%.2f"|format(change) }}</span>
                    {% elif change < 0 %}
                        <span style="color: #ef4444;">â–¼ {{ "%.2f"|format(change|abs) }}</span>
                    {% else %}
                        <span style="color: #6b7280;">â€” No change</span>
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            <tr>
                <th>Samples Collected</th>
                <td>{{ metadata.sample_count }}</td>
            </tr>
        </table>
    {% else %}
        <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">{{ metadata | tojson(indent=2) }}</pre>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <h3>Recent Snapshots</h3>
    {% if history %}
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Sentiment</th>
                <th>Confidence</th>
                <th>Volatility</th>
                <th>Anomaly Score</th>
                <th>Coverage</th>
            </tr>
        </thead>
        <tbody>
            {% for snapshot in history %}
            <tr>
                <td data-utc-timestamp="{{ snapshot.timestamp.isoformat() }}">{{ snapshot.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} UTC</td>
                <td class="{% if snapshot.sentiment > 0.1 %}sentiment-positive{% elif snapshot.sentiment < -0.1 %}sentiment-negative{% else %}sentiment-neutral{% endif %}">
                    {{ "%.3f"|format(snapshot.sentiment) }}
                </td>
                <td>{{ "%.2f"|format(snapshot.sentiment_confidence * 100) }}%</td>
                <td>{{ "%.3f"|format(snapshot.volatility) }}</td>
                <td>{{ "%.3f"|format(snapshot.anomaly_score) }}</td>
                <td>{{ "%.2f"|format(snapshot.coverage * 100) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No snapshots collected yet.</p>
    {% endif %}
</div>

<div style="margin-top: 1rem;">
    <a href="/sources" class="btn">Back to Sources</a>
</div>

<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
    z-index: 1000;
    max-width: 400px;
}

.notification-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.notification-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.btn-collecting {
    opacity: 0.6;
    pointer-events: none;
}
</style>

<script>
// Convert UTC timestamps to local time
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-utc-timestamp]').forEach(cell => {
        const utcTimestamp = cell.getAttribute('data-utc-timestamp');
        // Add 'Z' suffix if not present to ensure UTC interpretation
        const isoString = utcTimestamp.endsWith('Z') ? utcTimestamp : utcTimestamp + 'Z';
        const date = new Date(isoString);
        
        // Format: YYYY-MM-DD HH:MM:SS
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        
        cell.textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    });
});

async function collectNow(sourceId, sourceName) {
    const btn = document.getElementById('collect-btn');
    const originalText = btn.innerHTML;
    
    // Disable button and show loading state
    btn.classList.add('btn-collecting');
    btn.innerHTML = 'â³ Collecting...';
    
    try {
        const response = await fetch(`/sources/${sourceId}/collect`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(`âœ“ Successfully collected data from "${sourceName}"`, 'success');
            // Reload page after 1 second to show new data
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification(`âœ— Failed to collect from "${sourceName}": ${result.message || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        showNotification(`âœ— Error collecting from "${sourceName}": ${error.message}`, 'error');
    } finally {
        // Re-enable button
        btn.classList.remove('btn-collecting');
        btn.innerHTML = originalText;
    }
}

function showNotification(message, type) {
    // Remove existing notifications
    const existing = document.querySelectorAll('.notification');
    existing.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}
