{% extends "base.html" %}

{% block title %}{{ source.display_name }} - Parallax Index{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>{{ source.display_name }}</h2>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/sources/{{ source.source_id }}/edit" class="btn" style="background: #2c5282; color: white;">Edit</a>
        <form method="POST" action="/sources/{{ source.source_id }}/toggle" style="display: inline;">
            <button type="submit" class="btn">
                {% if source.enabled %}Disable{% else %}Enable{% endif %}
            </button>
        </form>
        <form method="POST" action="/sources/{{ source.source_id }}/collect" style="display: inline;">
            <button type="submit" class="btn btn-success">Collect Now</button>
        </form>
    </div>
</div>

<div class="card">
    <h3>Source Information</h3>
    <table>
        <tr>
            <th>Plugin</th>
            <td>{{ plugin.display_name }} ({{ plugin.plugin_id }})</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if source.enabled %}
                <span class="badge badge-enabled">Enabled</span>
                {% else %}
                <span class="badge badge-disabled">Disabled</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Weight</th>
            <td>{{ source.weight }}</td>
        </tr>
        <tr>
            <th>Polarity</th>
            <td>{{ source.sentiment_polarity.value }}</td>
        </tr>
        <tr>
            <th>Schedule</th>
            <td><code>{{ source.schedule }}</code></td>
        </tr>
        <tr>
            <th>Configuration</th>
            <td><pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px;">{{ source.config | tojson(indent=2) }}</pre></td>
        </tr>
        <tr>
            <th>Created</th>
            <td>{{ source.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</td>
        </tr>
    </table>
</div>

{% if history and history[0].metadata %}
<div class="card">
    <h3>Current Data</h3>
    {% set metadata = history[0].metadata %}
    {% if source.plugin_id == 'NUMERIC' or source.plugin_id == 'numeric_index' %}
        <table>
            <tr>
                <th>Sentiment Mode</th>
                <td>
                    <strong>{{ metadata.get('mode', 'change_tracking').replace('_', ' ').title() }}</strong>
                    {% if metadata.get('mode') == 'higher_is_better' %}
                        <span style="color: #2e7d32;">â†‘ Higher values are better</span>
                    {% elif metadata.get('mode') == 'lower_is_better' %}
                        <span style="color: #d32f2f;">â†“ Lower values are better</span>
                    {% elif metadata.get('mode') == 'target_is_best' %}
                        <span style="color: #1976d2;">ðŸŽ¯ Closer to target is better</span>
                    {% else %}
                        <span style="color: #6b7280;">Tracks percent change</span>
                    {% endif %}
                </td>
            </tr>
            {% if metadata.get('configured_min') is not none %}
            <tr>
                <th>Configured Range</th>
                <td>
                    {{ "%.2f"|format(metadata.configured_min) }} to {{ "%.2f"|format(metadata.configured_max) }}
                    {% if metadata.get('configured_midpoint') is not none %}
                        (midpoint: {{ "%.2f"|format(metadata.configured_midpoint) }})
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            <tr>
                <th>Current Value</th>
                <td style="font-size: 1.5rem; font-weight: bold; color: #2c5282;">{{ "%.2f"|format(metadata.current_value) }}</td>
            </tr>
            <tr>
                <th>Observed Range</th>
                <td>
                    {{ "%.2f"|format(metadata.get('observed_min', metadata.get('min_value', 0))) }} 
                    to 
                    {{ "%.2f"|format(metadata.get('observed_max', metadata.get('max_value', 0))) }}
                    (span: {{ "%.2f"|format(metadata.get('observed_max', metadata.get('max_value', 0)) - metadata.get('observed_min', metadata.get('min_value', 0))) }})
                </td>
            </tr>
            {% if metadata.previous_value is not none %}
            <tr>
                <th>Change from Previous</th>
                <td>
                    {% set change = metadata.current_value - metadata.previous_value %}
                    {% if change > 0 %}
                        <span style="color: #22c55e;">â–² {{ "%.2f"|format(change) }}</span>
                    {% elif change < 0 %}
                        <span style="color: #ef4444;">â–¼ {{ "%.2f"|format(change|abs) }}</span>
                    {% else %}
                        <span style="color: #6b7280;">â€” No change</span>
                    {% endif %}
                </td>
            </tr>
            {% endif %}
            <tr>
                <th>Samples Collected</th>
                <td>{{ metadata.sample_count }}</td>
            </tr>
        </table>
    {% else %}
        <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">{{ metadata | tojson(indent=2) }}</pre>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <h3>Recent Snapshots</h3>
    {% if history %}
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Sentiment</th>
                <th>Confidence</th>
                <th>Volatility</th>
                <th>Anomaly Score</th>
                <th>Coverage</th>
            </tr>
        </thead>
        <tbody>
            {% for snapshot in history %}
            <tr>
                <td>{{ snapshot.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td class="{% if snapshot.sentiment > 0.1 %}sentiment-positive{% elif snapshot.sentiment < -0.1 %}sentiment-negative{% else %}sentiment-neutral{% endif %}">
                    {{ "%.3f"|format(snapshot.sentiment) }}
                </td>
                <td>{{ "%.2f"|format(snapshot.sentiment_confidence * 100) }}%</td>
                <td>{{ "%.3f"|format(snapshot.volatility) }}</td>
                <td>{{ "%.3f"|format(snapshot.anomaly_score) }}</td>
                <td>{{ "%.2f"|format(snapshot.coverage * 100) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No snapshots collected yet.</p>
    {% endif %}
</div>

<div style="margin-top: 1rem;">
    <a href="/sources" class="btn">Back to Sources</a>
</div>
{% endblock %}
