{% extends "base.html" %}

{% block title %}Sources - Parallax Index{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>Sources</h2>
    <a href="/sources/new" class="btn btn-success">Add New Source</a>
</div>

<div class="card">
    {% if sources %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Plugin</th>
                <th>Status</th>
                <th>Weight</th>
                <th>Schedule</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in sources %}
            <tr>
                <td>
                    <a href="/sources/{{ item.source.source_id }}" style="color: #2c5282; text-decoration: none; font-weight: 600;">
                        {{ item.source.display_name }}
                    </a>
                </td>
                <td>{{ item.source.plugin_id }}</td>
                <td>
                    {% if item.source.enabled %}
                    <span class="badge badge-enabled">Enabled</span>
                    {% else %}
                    <span class="badge badge-disabled">Disabled</span>
                    {% endif %}
                </td>
                <td>{{ item.source.weight }}</td>
                <td>
                    <span style="color: #2e7d32; font-weight: 500;">{{ item.schedule_human }}</span>
                    <br>
                    <small style="color: #7f8c8d; font-family: monospace;">{{ item.source.schedule }}</small>
                </td>
                <td>{{ item.source.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="/sources/{{ item.source.source_id }}" class="btn">View</a>
                        <button class="btn" 
                                onclick="collectNow('{{ item.source.source_id }}', '{{ item.source.display_name }}')"
                                id="collect-btn-{{ item.source.source_id }}"
                                style="background: #3498db; color: white;">
                            ⚡ Collect
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No sources configured yet.</p>
    <a href="/sources/new" class="btn btn-success">Add Your First Source</a>
    {% endif %}
</div>

<style>
.btn-collecting {
    opacity: 0.6;
    pointer-events: none;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
    z-index: 1000;
    max-width: 400px;
}

.notification-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.notification-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>

<script>
async function collectNow(sourceId, sourceName) {
    const btn = document.getElementById(`collect-btn-${sourceId}`);
    const originalText = btn.innerHTML;
    
    // Disable button and show loading state
    btn.classList.add('btn-collecting');
    btn.innerHTML = '⏳ Collecting...';
    
    try {
        const response = await fetch(`/sources/${sourceId}/collect`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(`✓ Successfully collected data from "${sourceName}"`, 'success');
        } else {
            showNotification(`✗ Failed to collect from "${sourceName}": ${result.message || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        showNotification(`✗ Error collecting from "${sourceName}": ${error.message}`, 'error');
    } finally {
        // Re-enable button
        btn.classList.remove('btn-collecting');
        btn.innerHTML = originalText;
    }
}

function showNotification(message, type) {
    // Remove existing notifications
    const existing = document.querySelectorAll('.notification');
    existing.forEach(n => n.remove());
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}